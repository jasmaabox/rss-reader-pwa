// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Rss from "../feeds/Rss.bs.js";
import * as $$Array from "rescript/lib/es6/array.js";
import * as Curry from "rescript/lib/es6/curry.js";
import * as React from "react";
import * as $$Storage from "../Storage.bs.js";
import * as Belt_Set from "rescript/lib/es6/belt_Set.js";
import * as PostCard from "../components/PostCard.bs.js";

function Home$Home(Props) {
  var match = React.useState(function () {
        return [];
      });
  var setPosts = match[1];
  var match$1 = React.useState(function () {
        return $$Storage.getContentProviders(undefined);
      });
  var setContentProviders = match$1[1];
  var contentProviders = match$1[0];
  var match$2 = React.useState(function () {
        return "";
      });
  var setName = match$2[1];
  var name = match$2[0];
  var match$3 = React.useState(function () {
        return "";
      });
  var setFeedUrl = match$3[1];
  var feedUrl = match$3[0];
  var onChangeName = function (evt) {
    var value = evt.currentTarget.value;
    return Curry._1(setName, (function (param) {
                  return value;
                }));
  };
  var onChangeFeedUrl = function (evt) {
    var value = evt.currentTarget.value;
    return Curry._1(setFeedUrl, (function (param) {
                  return value;
                }));
  };
  var fetchPosts = function (url) {
    var corsProxyUrl = process.env.REACT_APP_CORS_PROXY_URL;
    if (corsProxyUrl !== undefined) {
      var rssUrl = new URL(corsProxyUrl);
      rssUrl.searchParams.set("targetURL", url);
      var __x = fetch(rssUrl.toString());
      var __x$1 = __x.then(function (res) {
            return res.text();
          });
      var __x$2 = __x$1.then(function (res) {
            var rss = Rss.parseFeed(res);
            return Promise.resolve(rss.posts);
          });
      return __x$2.catch(function (err) {
                  console.log(err);
                  return Promise.resolve([]);
                });
    }
    console.log("No cors proxy found.");
    return Promise.resolve([]);
  };
  React.useEffect((function () {
          var urls = Belt_Set.toArray(contentProviders).map(function (contentProvider) {
                  return contentProvider.feedUrl;
                }).map(fetchPosts);
          var __x = Promise.all(urls);
          __x.then(function (res) {
                var allPosts = res.reduce((function (acc, posts) {
                        return acc.concat(posts);
                      }), []);
                Curry._1(setPosts, (function (_prev) {
                        return allPosts;
                      }));
                return Promise.resolve(undefined);
              });
          
        }), [contentProviders]);
  var onAddContentProvider = function (evt) {
    evt.preventDefault();
    var provider = {
      name: name,
      feedUrl: feedUrl
    };
    Curry._1(setName, (function (param) {
            return "";
          }));
    Curry._1(setFeedUrl, (function (param) {
            return "";
          }));
    var updatedContentProviders = Belt_Set.add(contentProviders, provider);
    Curry._1(setContentProviders, (function (param) {
            return updatedContentProviders;
          }));
    return $$Storage.setContentProviders(updatedContentProviders);
  };
  return React.createElement("div", undefined, React.createElement("h1", undefined, "RSS Reader"), React.createElement("form", {
                  onSubmit: onAddContentProvider
                }, React.createElement("input", {
                      name: "name",
                      placeholder: "RSS Feed Name",
                      type: "text",
                      value: name,
                      onChange: onChangeName
                    }), React.createElement("input", {
                      name: "feed-url",
                      placeholder: "RSS Feed URL",
                      type: "text",
                      value: feedUrl,
                      onChange: onChangeFeedUrl
                    }), React.createElement("input", {
                      type: "submit",
                      value: "Add feed"
                    })), $$Array.map((function (post) {
                    return React.createElement(PostCard.PostCard.make, {
                                post: post,
                                key: post.guid
                              });
                  }), match[0]));
}

var Home = {
  make: Home$Home
};

export {
  Home ,
  
}
/* react Not a pure module */
